name: Nexus Dashboard CI/CD

on:
    push:
        branches: [main, develop]
        tags:
            - "v*"
    pull_request:
        branches: [main, develop]
    workflow_dispatch:

env:
    FLUTTER_VERSION: "3.24.0" # Updated to support flutter_lints 5.0.0
    JAVA_VERSION: "17"

jobs:
    # ============================================
    # Code Quality & Testing
    # ============================================
    analyze-and-test:
        name: Code Analysis & Testing
        runs-on: ubuntu-latest
        timeout-minutes: 30

        steps:
            - name: ðŸ“¥ Checkout repository
              uses: actions/checkout@v4

            - name: â˜• Setup Java
              uses: actions/setup-java@v3
              with:
                  distribution: "zulu"
                  java-version: ${{ env.JAVA_VERSION }}

            - name: ðŸ¦ Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  flutter-version: ${{ env.FLUTTER_VERSION }}
                  channel: "stable"
                  cache: true

            - name: ðŸ“¦ Get dependencies
              run: flutter pub get

            - name: ðŸ”Ž Analyze code
              run: flutter analyze --fatal-infos

    # ============================================
    # Build Android
    # ============================================
    build-android:
        name: Build Android APK/AAB
        runs-on: ubuntu-latest
        needs: analyze-and-test
        if: github.event_name == 'push' || startsWith(github.ref, 'refs/tags/v')
        timeout-minutes: 45

        steps:
            - name: ðŸ“¥ Checkout repository
              uses: actions/checkout@v4

            - name: â˜• Setup Java
              uses: actions/setup-java@v3
              with:
                  distribution: "zulu"
                  java-version: ${{ env.JAVA_VERSION }}

            - name: ðŸ¦ Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  flutter-version: ${{ env.FLUTTER_VERSION }}
                  channel: "stable"
                  cache: true

            - name: ðŸ“¦ Get dependencies
              run: flutter pub get

            - name: ðŸ”§ Decode keystore
              if: startsWith(github.ref, 'refs/tags/v')
              env:
                  ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
              run: |
                  echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > android/app/keystore.jks

            - name: ðŸ”‘ Create key.properties
              if: startsWith(github.ref, 'refs/tags/v')
              env:
                  KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
                  KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
                  KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
              run: |
                  cat > android/key.properties << EOF
                  storePassword=$KEYSTORE_PASSWORD
                  keyPassword=$KEY_PASSWORD
                  keyAlias=$KEY_ALIAS
                  storeFile=keystore.jks
                  EOF

            - name: ðŸ—ï¸ Build APK (Debug)
              if: github.ref == 'refs/heads/develop'
              run: flutter build apk --debug --target-platform android-arm64

            - name: ðŸ—ï¸ Build APK (Release)
              if: startsWith(github.ref, 'refs/tags/v')
              run: flutter build apk --release --split-per-abi

            - name: ðŸ—ï¸ Build App Bundle
              if: startsWith(github.ref, 'refs/tags/v')
              run: flutter build appbundle --release

            - name: ðŸ“¤ Upload APK artifact
              uses: actions/upload-artifact@v4
              with:
                  name: android-apk
                  path: |
                      build/app/outputs/flutter-apk/*.apk
                      build/app/outputs/bundle/release/*.aab
                  retention-days: 30

            - name: ðŸš€ Deploy to Firebase App Distribution
              if: github.ref == 'refs/heads/develop'
              uses: wzieba/Firebase-Distribution-Github-Action@v1
              with:
                  appId: ${{ secrets.FIREBASE_ANDROID_APP_ID }}
                  serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
                  groups: internal-testers
                  file: build/app/outputs/flutter-apk/app-debug.apk
                  releaseNotes: |
                      Development build from commit: ${{ github.sha }}
                      Branch: ${{ github.ref_name }}

    # ============================================
    # Build iOS
    # ============================================
    build-ios:
        name: Build iOS IPA
        runs-on: macos-latest
        needs: analyze-and-test
        if: github.event_name == 'push' || startsWith(github.ref, 'refs/tags/v')
        timeout-minutes: 60

        steps:
            - name: ðŸ“¥ Checkout repository
              uses: actions/checkout@v4

            - name: ðŸ¦ Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  flutter-version: ${{ env.FLUTTER_VERSION }}
                  channel: "stable"
                  cache: true

            - name: ðŸ“¦ Get dependencies
              run: flutter pub get

            - name: ðŸŽ Setup Xcode
              uses: maxim-lobanov/setup-xcode@v1
              with:
                  xcode-version: "latest"

            - name: ðŸ“± Install CocoaPods
              run: |
                  cd ios
                  pod install
                  cd ..

            - name: ðŸ” Install Apple Certificate
              if: startsWith(github.ref, 'refs/tags/v')
              env:
                  BUILD_CERTIFICATE_BASE64: ${{ secrets.IOS_BUILD_CERTIFICATE_BASE64 }}
                  P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
                  BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.IOS_BUILD_PROVISION_PROFILE_BASE64 }}
                  KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
              run: |
                  # Create variables
                  CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
                  PP_PATH=$RUNNER_TEMP/build_pp.mobileprovision
                  KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

                  # Import certificate and provisioning profile from secrets
                  echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode --output $CERTIFICATE_PATH
                  echo -n "$BUILD_PROVISION_PROFILE_BASE64" | base64 --decode --output $PP_PATH

                  # Create temporary keychain
                  security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
                  security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
                  security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

                  # Import certificate to keychain
                  security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
                  security list-keychain -d user -s $KEYCHAIN_PATH

                  # Apply provisioning profile
                  mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
                  cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles

            - name: ðŸ—ï¸ Build iOS (Debug)
              if: github.ref == 'refs/heads/develop'
              run: flutter build ios --debug --no-codesign

            - name: ðŸ—ï¸ Build iOS (Release)
              if: startsWith(github.ref, 'refs/tags/v')
              run: flutter build ios --release --no-codesign

            - name: ðŸ“¦ Create IPA
              if: startsWith(github.ref, 'refs/tags/v')
              run: |
                  cd build/ios/iphoneos
                  mkdir Payload
                  cp -r Runner.app Payload
                  zip -r nexus_dashboard.ipa Payload

            - name: ðŸ“¤ Upload IPA artifact
              if: startsWith(github.ref, 'refs/tags/v')
              uses: actions/upload-artifact@v4
              with:
                  name: ios-ipa
                  path: build/ios/iphoneos/nexus_dashboard.ipa
                  retention-days: 30

            - name: ðŸš€ Deploy to TestFlight
              if: startsWith(github.ref, 'refs/tags/v')
              env:
                  APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
              run: |
                  xcrun altool --upload-app \
                    --type ios \
                    --file build/ios/iphoneos/nexus_dashboard.ipa \
                    --apiKey $APP_STORE_CONNECT_API_KEY

            - name: ðŸ§¹ Clean up keychain
              if: always() && startsWith(github.ref, 'refs/tags/v')
              run: |
                  security delete-keychain $RUNNER_TEMP/app-signing.keychain-db

    # ============================================
    # Notification
    # ============================================
    notify:
        name: Send Notifications
        runs-on: ubuntu-latest
        needs: [analyze-and-test, build-android, build-ios]
        if: always()

        steps:
            - name: ðŸ’¬ Slack Notification
              uses: 8398a7/action-slack@v3
              if: always()
              with:
                  status: ${{ job.status }}
                  text: |
                      Nexus Dashboard CI/CD Pipeline
                      Commit: ${{ github.sha }}
                      Author: ${{ github.actor }}
                      Branch: ${{ github.ref_name }}
                      Status: ${{ job.status }}
                  webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
                  fields: repo,message,commit,author,action,eventName,ref,workflow

            - name: ðŸ“§ Email Notification
              if: failure()
              uses: dawidd6/action-send-mail@v3
              with:
                  server_address: smtp.gmail.com
                  server_port: 465
                  username: ${{ secrets.EMAIL_USERNAME }}
                  password: ${{ secrets.EMAIL_PASSWORD }}
                  subject: Nexus Dashboard - Build Failed
                  to: victor@example.com
                  from: CI/CD Pipeline
                  body: |
                      Build failed for Nexus Dashboard

                      Commit: ${{ github.sha }}
                      Author: ${{ github.actor }}
                      Branch: ${{ github.ref_name }}

                      Please check the GitHub Actions logs for details.
